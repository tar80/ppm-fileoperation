var e={ppmName:"ppx-plugin-manager",ppmVersion:.95,language:"ja",encode:"utf16le",nlcode:"\r\n",nltype:"crlf",ppmID:"P",ppmSubID:"Q"},useLanguage=function(){var r=PPx.Extract("%*getcust(S_ppm#global:lang)");return"en"===r||"ja"===r?r:e.language},r=PPx.CreateObject("Scripting.FileSystemObject"),isEmptyStr=function(e){return""===e};Array.prototype.includes||(Array.prototype.includes=function(e,r){if(null==this)throw new Error('Array.includes: "this" is null or not defined');var t=Object(this),n=t.length>>>0;if(0===n)return!1;var o=null!=r?r:0,i=Math.max(o>=0?o:n-Math.abs(o),0);function sameValueZero(e,r){return e===r||"number"==typeof e&&"number"==typeof r&&isNaN(e)&&isNaN(r)}for(;i<n;){if(sameValueZero(t[i],e))return!0;i++}return!1});var t={TypeToCode:{crlf:"\r\n",cr:"\r",lf:"\n"},CodeToType:{"\r\n":"crlf","\r":"cr","\n":"lf"},Ppx:{lf:"%%bl",cr:"%%br",crlf:"%%bn",unix:"%%bl",mac:"%%br",dos:"%%bn","\n":"%%bl","\r":"%%br","\r\n":"%%bn"},Ascii:{lf:"10",cr:"13",crlf:"-1",unix:"10",mac:"13",dos:"-1","\n":"10","\r":"13","\r\n":"-1"}},expandNlCode=function(e){var r="\n",t=e.indexOf("\r");return~t&&(r="\r\n"===e.substring(t,t+2)?"\r\n":"\r"),r},isCV8=function(){return"ClearScriptV8"===PPx.ScriptEngineName},_exec=function(e,r){try{var t;return[!1,null!=(t=r())?t:""]}catch(n){return[!0,""]}finally{e.Close()}},read=function(e){var t=e.path,n=e.enc,o=void 0===n?"utf8":n;if(!r.FileExists(t))return[!0,t+" not found"];var i=r.GetFile(t);if(0===i.Size)return[!0,t+" has no data"];var a=!1,u="";if("utf8"===o){var c=PPx.CreateObject("ADODB.Stream"),l=_exec(c,(function(){return c.Open(),c.Charset="UTF-8",c.LoadFromFile(t),c.ReadText(-1)}));a=l[0],u=l[1]}else{var s="utf16le"===o?-1:0,d=i.OpenAsTextStream(1,s),f=_exec(d,(function(){return d.ReadAll()}));a=f[0],u=f[1]}return a?[!0,"Unable to read "+t]:[!1,u]},readLines=function(e){var r,t=e.path,n=e.enc,o=void 0===n?"utf8":n,i=e.linefeed,a=read({path:t,enc:o}),u=a[0],c=a[1];if(u)return[!0,c];i=null!=(r=i)?r:expandNlCode(c.slice(0,1e3));var l=c.split(i);return isEmptyStr(l[l.length-1])&&l.pop(),[!1,{lines:l,nl:i}]},writeLines=function(n){var o=n.path,i=n.data,a=n.enc,u=void 0===a?"utf8":a,c=n.append,l=void 0!==c&&c,s=n.overwrite,d=void 0!==s&&s,f=n.linefeed,x=void 0===f?e.nlcode:f;if(!d&&!l&&r.FileExists(o))return[!0,o+" already exists"];var p,P=r.GetParentFolderName(o);if(r.FolderExists(P)||PPx.Execute("*makedir "+P),"utf8"===u){if(isCV8()){var v=i.join(x),m=l?"AppendAllText":"WriteAllText";return[!1,NETAPI.System.IO.File[m](o,v)]}var E=d||l?2:1,h=PPx.CreateObject("ADODB.Stream");p=_exec(h,(function(){h.Open(),h.Charset="UTF-8",h.LineSeparator=Number(t.Ascii[x]),l?(h.LoadFromFile(o),h.Position=h.Size,h.SetEOS):h.Position=0,h.WriteText(i.join(x),1),h.SaveToFile(o,E)}))[0]}else{var b=l?8:d?2:1;r.FileExists(o)||PPx.Execute("%Osq *makefile "+o);var g="utf16le"===u?-1:0,F=r.GetFile(o).OpenAsTextStream(b,g);p=_exec(F,(function(){F.Write(i.join(x)+x)}))[0]}return p?[!0,"Could not write to "+o]:[!1,""]},pathSelf=function(){var e,r,t=PPx.ScriptName;return~t.indexOf("\\")?(e=extractFileName(t),r=PPx.Extract("%*name(DKN,"+t+")")):(e=t,r=PPx.Extract("%FDN")),{scriptName:e,parentDir:r.replace(/\\$/,"")}},extractFileName=function(e,r){return void 0===r&&(r="\\"),"\\"!==r&&"/"!==r&&(r="\\"),e.slice(e.lastIndexOf(r)+1)},n={en:{couldNotRead:"Could not read result log",noHistory:"No undo history",errorDetected:"An error has been detected",notFound:"is not found",unknown:"Unknown process",noUndo:"No undo"},ja:{couldNotRead:"ログを読めませんでした",noHistory:"アンドゥ履歴はありません",errorDetected:"エラーを検出しました",notFound:"はありません",unknown:"不明なプロセス",noUndo:"処理なし"}},o="ppm-fileoperation",i=e.nlcode,a=useLanguage();pathSelf();var _dialog=function(e,r){return 0===PPx.Execute('%"'+o+'" %OC %'+e+'"'+r+'"')},_hasTargetId=function(e){return"."!==e},u={echo:function(e,r){var t=r?"("+String(r)+")":"";return _dialog("I",""+e+t)},question:function(e){return _dialog("Q",e)},execute:function(e,r,t){return void 0===t&&(t=!1),isEmptyStr(r)?1:_hasTargetId(e)?t?Number(PPx.Extract("%*extract("+e+',"'+r+'%%:0")')):PPx.Execute("*execute "+e+","+r):PPx.Execute(r)},extract:function(e,r){if(isEmptyStr(r))return[13,""];var t=_hasTargetId(e)?PPx.Extract("%*extract("+e+',"'+r+'")'):PPx.Extract(r);return[Number(PPx.Extract()),t]}},c="PPXUNDO.LOG",undologPath=function(){var e=PPx.Extract("%*getcust(X_save)%\\"+c);return~e.indexOf(":")||(e=PPx.Extract("%0%\\")+e),PPx.Execute('%OC *execute ,*ifmatch "o:e,a:d-","'+e+'"%%:*stop%bn*makefile "'+e+'"%%&'),e},l={undologRead:function(){return readLines({path:undologPath(),enc:e.encode,linefeed:i})},undologWrite:function(r){writeLines({path:undologPath(),data:r,enc:e.encode,linefeed:i,overwrite:!0})},updatePairedWindow:function(){return PPx.Execute('*ifmatch C*,%~n%:%K~"@^F5"')}},s=n[a],main=function(){var e=undo(),r=e[0],t=e[1];r?u.echo(t):""!==u.extract("C","%%2")[1]&&l.updatePairedWindow()},undo=function(){var t=l.undologRead(),n=t[0],o=t[1];if(n)return[!0,s.couldNotRead];if(0===o.lines.length)return[!0,s.noHistory];var i=["[INFO] Undo"],a=[s.errorDetected,""],c=!1,d=0;do{var f=o.lines[d];if(!isEmptyStr(f)){var x=f.split("\t"),p=x[0],P=x[1];if(d++,"Skip"!==p&&"MakeDir"!==p){var v=o.lines[d].split("\t")[1];switch(d++,p){case"MoveError":case"Copy AutoRetryError":case"Error SkipError":a.push(f);continue;case"Move":case"MoveDir":c=!0;break;case"Backup":if(!r.FileExists(v)&&!r.FolderExists(v))return[!0,v+" "+s.notFound];d++,c=!0;break;default:return[!0,s.unknown+' "'+p+'"']}i.push("Send "+P,"Dest -> "+v)}}}while(o.lines[d]);return c?(a.length>2&&(u.question(a.join("%%bn"))&&PPx.Quit(1),overwrite("skip")),PPx.Execute("*wait 0,1"),PPx.linemessage(i.join(e.nlcode)),"1"!==PPx.Extract("*file !undo -min -nocount -log:off%:1")&&PPx.Quit(1),overwrite("redo"),[!1,""]):[!0,s.noUndo]},overwrite=function(r){var t=l.undologRead(),n=t[0],o=t[1];if(!n){for(var i=[],a=0;o.lines[a];){var u=o.lines[a];if(!isEmptyStr(u)){var c=u.split("\t"),s=c[0],d=c[1];if(a++,"Skip"!==s)if("MoveError"!==s&&"Copy AutoRetryError"!==s&&"Error SkipError"!==s)if("Backup"!==s){var f=o.lines[a].split("\t")[1],x={skip:{send:d,dest:f},redo:{send:f,dest:d}}[r];i.push("Move\t"+x.send+e.nlcode+" ->\t"+x.dest),a++}else a+=2;else a++}}l.undologWrite(i)}};main();
