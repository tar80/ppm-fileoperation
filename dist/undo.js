var e={ppmName:"ppx-plugin-manager",ppmVersion:.95,language:"ja",encode:"utf16le",nlcode:"\r\n",nltype:"crlf",ppmID:"P",ppmSubID:"Q"},r={actions:"S_ppm#actions",event:"S_ppm#event",global:"S_ppm#global",sources:"S_ppm#sources",staymode:"S_ppm#staymode",user:"S_ppm#user"},useLanguage=function(){var t=PPx.Extract("%*getcust("+r.global+":lang)");return"en"===t||"ja"===t?t:e.language},t=PPx.CreateObject("Scripting.FileSystemObject"),isEmptyStr=function(e){return""===e};Array.prototype.includes||(Array.prototype.includes=function(e,r){if(null==this)throw new Error('Array.includes: "this" is null or not defined');var t=Object(this),n=t.length>>>0;if(0===n)return!1;var o=null!=r?r:0,i=Math.max(o>=0?o:n-Math.abs(o),0);function sameValueZero(e,r){return e===r||"number"==typeof e&&"number"==typeof r&&isNaN(e)&&isNaN(r)}for(;i<n;){if(sameValueZero(t[i],e))return!0;i++}return!1});var n={TypeToCode:{crlf:"\r\n",cr:"\r",lf:"\n"},CodeToType:{"\r\n":"crlf","\r":"cr","\n":"lf"},Ppx:{lf:"%%bl",cr:"%%br",crlf:"%%bn",unix:"%%bl",mac:"%%br",dos:"%%bn","\n":"%%bl","\r":"%%br","\r\n":"%%bn"},Ascii:{lf:"10",cr:"13",crlf:"-1",unix:"10",mac:"13",dos:"-1","\n":"10","\r":"13","\r\n":"-1"}},expandNlCode=function(e){var r="\n",t=e.indexOf("\r");return~t&&(r="\r\n"===e.substring(t,t+2)?"\r\n":"\r"),r},isCV8=function(){return"ClearScriptV8"===PPx.ScriptEngineName},_exec=function(e,r){try{var t;return[!1,null!=(t=r())?t:""]}catch(n){return[!0,""]}finally{e.Close()}},read=function(e){var r=e.path,n=e.enc,o=void 0===n?"utf8":n;if(!t.FileExists(r))return[!0,r+" not found"];var i=t.GetFile(r);if(0===i.Size)return[!0,r+" has no data"];var a=!1,u="";if("utf8"===o){var c=PPx.CreateObject("ADODB.Stream"),l=_exec(c,(function(){return c.Open(),c.Charset="UTF-8",c.LoadFromFile(r),c.ReadText(-1)}));a=l[0],u=l[1]}else{var s="utf16le"===o?-1:0,d=i.OpenAsTextStream(1,s),f=_exec(d,(function(){return d.ReadAll()}));a=f[0],u=f[1]}return a?[!0,"Unable to read "+r]:[!1,u]},readLines=function(e){var r,t=e.path,n=e.enc,o=void 0===n?"utf8":n,i=e.linefeed,a=read({path:t,enc:o}),u=a[0],c=a[1];if(u)return[!0,c];i=null!=(r=i)?r:expandNlCode(c.slice(0,1e3));var l=c.split(i);return isEmptyStr(l[l.length-1])&&l.pop(),[!1,{lines:l,nl:i}]},writeLines=function(r){var o=r.path,i=r.data,a=r.enc,u=void 0===a?"utf8":a,c=r.append,l=void 0!==c&&c,s=r.overwrite,d=void 0!==s&&s,f=r.linefeed,p=void 0===f?e.nlcode:f;if(!d&&!l&&t.FileExists(o))return[!0,o+" already exists"];var x,P=t.GetParentFolderName(o);if(t.FolderExists(P)||PPx.Execute("*makedir "+P),"utf8"===u){if(isCV8()){var v=i.join(p),m=l?"AppendAllText":"WriteAllText";return[!1,NETAPI.System.IO.File[m](o,v)]}var E=d||l?2:1,b=PPx.CreateObject("ADODB.Stream");x=_exec(b,(function(){b.Open(),b.Charset="UTF-8",b.LineSeparator=Number(n.Ascii[p]),l?(b.LoadFromFile(o),b.Position=b.Size,b.SetEOS):b.Position=0,b.WriteText(i.join(p),1),b.SaveToFile(o,E)}))[0]}else{var h=l?8:d?2:1;t.FileExists(o)||PPx.Execute("%Osq *makefile "+o);var S="utf16le"===u?-1:0,g=t.GetFile(o).OpenAsTextStream(h,S);x=_exec(g,(function(){g.Write(i.join(p)+p)}))[0]}return x?[!0,"Could not write to "+o]:[!1,""]},pathSelf=function(){var e,r,t=PPx.ScriptName;return~t.indexOf("\\")?(e=extractFileName(t),r=PPx.Extract("%*name(DKN,"+t+")")):(e=t,r=PPx.Extract("%FDN")),{scriptName:e,parentDir:r.replace(/\\$/,"")}},extractFileName=function(e,r){return void 0===r&&(r="\\"),"\\"!==r&&"/"!==r&&(r="\\"),e.slice(e.lastIndexOf(r)+1)},o={en:{couldNotRead:"Could not read result log",noHistory:"No undo history",errorDetected:"An error has been detected",notFound:"is not found",unknown:"Unknown process",noUndo:"No undo"},ja:{couldNotRead:"ログを読めませんでした",noHistory:"アンドゥ履歴はありません",errorDetected:"エラーを検出しました",notFound:"はありません",unknown:"不明なプロセス",noUndo:"処理なし"}},i="ppm-fileoperation",a=e.nlcode,u=useLanguage();pathSelf();var _dialog=function(e,r){return 0===PPx.Execute('%"'+i+'" %OC %'+e+'"'+r+'"')},_hasTargetId=function(e){return"."!==e},c={echo:function(e,r){var t=r?"("+String(r)+")":"";return _dialog("I",""+e+t)},question:function(e){return _dialog("Q",e)},execute:function(e,r,t){return void 0===t&&(t=!1),isEmptyStr(r)?1:_hasTargetId(e)?t?Number(PPx.Extract("%*extract("+e+',"'+r+'%%:0")')):PPx.Execute("*execute "+e+","+r):PPx.Execute(r)},extract:function(e,r){if(isEmptyStr(r))return[13,""];var t=_hasTargetId(e)?PPx.Extract("%*extract("+e+',"'+r+'")'):PPx.Extract(r);return[Number(PPx.Extract()),t]}},l="PPXUNDO.LOG",undologPath=function(){var e=PPx.Extract("%*getcust(X_save)%\\"+l);return~e.indexOf(":")||(e=PPx.Extract("%0%\\")+e),PPx.Execute('%OC *execute ,*ifmatch "o:e,a:d-","'+e+'"%%:*stop%bn*makefile "'+e+'"%%&'),e},s={undologRead:function(){return readLines({path:undologPath(),enc:e.encode,linefeed:a})},undologWrite:function(r){writeLines({path:undologPath(),data:r,enc:e.encode,linefeed:a,overwrite:!0})},updatePairedWindow:function(){return PPx.Execute('*ifmatch C*,%~n%:%K~"@^F5"')}},d=o[u],main=function(){var e=undo(),r=e[0],t=e[1];r?c.echo(t):""!==c.extract("C","%%2")[1]&&s.updatePairedWindow()},undo=function(){var r=s.undologRead(),n=r[0],o=r[1];if(n)return[!0,d.couldNotRead];if(0===o.lines.length)return[!0,d.noHistory];var i=["[INFO] Undo"],a=[d.errorDetected,""],u=!1,l=0;do{var f=o.lines[l];if(!isEmptyStr(f)){var p=f.split("\t"),x=p[0],P=p[1];if(l++," stat"===x)break;if("Skip"!==x&&"MakeDir"!==x){var v=o.lines[l].split("\t")[1];switch(l++,x){case"MoveError":case"Copy AutoRetryError":case"Error SkipError":a.push(f);continue;case"Move":case"MoveDir":u=!0;break;case"Backup":if(!t.FileExists(v)&&!t.FolderExists(v))return[!0,v+" "+d.notFound];l++,u=!0;break;default:return[!0,d.unknown+' "'+x+'"']}i.push("Send "+P,"Dest -> "+v)}}}while(o.lines[l]);return u?(a.length>2&&(c.question(a.join("%%bn"))&&PPx.Quit(1),overwrite("skip")),PPx.Execute("*wait 0,1"),PPx.linemessage(i.join(e.nlcode)),"1"!==PPx.Extract("*file !undo -min -nocount -log:off%:1")&&PPx.Quit(1),overwrite("redo"),[!1,""]):[!0,d.noUndo]},overwrite=function(r){var t=s.undologRead(),n=t[0],o=t[1];if(!n){for(var i=[],a=0;o.lines[a];){var u=o.lines[a];if(!isEmptyStr(u)){var c=u.split("\t"),l=c[0],d=c[1];if(a++," stat"===l)break;if("Skip"!==l)if("MoveError"!==l&&"Copy AutoRetryError"!==l&&"Error SkipError"!==l)if("Backup"!==l){var f=o.lines[a].split("\t")[1],p={skip:{send:d,dest:f},redo:{send:f,dest:d}}[r];i.push("Move\t"+p.send+e.nlcode+" ->\t"+p.dest),a++}else a+=2;else a++}}s.undologWrite(i)}};main();
