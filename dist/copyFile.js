var isEmptyStr=function(e){return""===e},withinRange=function(e,t){return e>=0&&e<=t};Array.prototype.includes||(Array.prototype.includes=function(e,t){if(null==this)throw new TypeError('Array.includes: "this" is null or not defined');var r=Object(this),n=r.length>>>0;if(0===n)return!1;var i=null!=t?t:0,a=Math.max(i>=0?i:n-Math.abs(i),0);function sameValueZero(e,t){return e===t||"number"==typeof e&&"number"==typeof t&&isNaN(e)&&isNaN(t)}for(;a<n;){if(sameValueZero(r[a],e))return!0;a++}return!1});var e=PPx.CreateObject("Scripting.FileSystemObject"),t={ppmName:"ppx-plugin-manager",ppmVersion:.95,language:"ja",nlcode:"\r\n",nltype:"crlf",ppmID:"P",ppmSubID:"Q"},useLanguage=function(){var e=PPx.Extract("%*getcust(S_ppm#global:lang)");return"en"===e||"ja"===e?e:t.language},pathSelf=function(){var e,t,r=PPx.ScriptName;return~r.indexOf("\\")?(e=r.replace(/^.*\\/,""),t=PPx.Extract("%*name(DKN,"+r+")")):(e=r,t=PPx.Extract("%FDN")),{scriptName:e,parentDir:t.replace(/\\$/,"")}},r={en:{sameName:"There is a file with the same name",notExist:"Cannot get entry",diffType:"File and directory cannot be renamed",couldNotGetFc:"Could not get the path to the fastcopy.exe\nPlease check the value of S_ppm#user:fo_fcdir",createTrash:"does not exist. Create a trash directory?"},ja:{sameName:"同名のファイルがあります",notExist:"エントリを取得できません",diffType:"ファイルとディレクトリの名前交換はできません",couldNotGetFc:"fastcopy.exeのパスを取得できませんでした\nS_ppm#user:fo_fcdirの値を確認してください",createTrash:"はありません。作成しますか?"}},n={en:{abort:"Abort. Not supported",fileExpand:"Specify path (archive file extraction)",createLink:"Specify path (create symbolic link)",notSupported:function(e){return"Operation to "+e+" is not supported"}},ja:{abort:"非対応ディレクトリ",fileExpand:"パスを指定 (書庫ファイル展開)",createLink:"パスを指定 (シンボリックリンク作成)",notSupported:function(e){return e+"への処理は非対応です"}}},i="ppm-fileoperation",a=useLanguage(),c=r[a],o=pathSelf().parentDir,_dialog=function(e,t){return 0===PPx.Execute('%"'+i+'" %OC %'+e+'"'+t+'"')},_hasTargetId=function(e){return"."!==e},u={echo:function(e,t){var r=t?"("+String(t)+")":"";return _dialog("I",""+e+r)},question:function(e){return _dialog("Q",e)},execute:function(e,t,r){return void 0===r&&(r=!1),isEmptyStr(t)?1:_hasTargetId(e)?r?Number(PPx.Extract("%*extract("+e+',"'+t+'%%:0")')):PPx.Execute("*execute "+e+","+t):PPx.Execute(t)},extract:function(e,t){if(isEmptyStr(t))return[13,""];var r=_hasTargetId(e)?PPx.Extract("%*extract("+e+',"'+t+'")'):PPx.Extract(t);return[Number(PPx.Extract()),r]}},pairsExtract=function(e,t){var r=t?e+"('"+t.replace(/\\/g,"\\\\")+"')":e;return u.extract("~",'%%*js(""PPx.result=PPx.'+r+';"")')},_getAttribute=function(e){switch(e){case 1:case 3:return"DIR";case 4:return"LISTFILE";case 5:case 6:case 7:case 8:case 10:case 21:return"SPECIAL";case 63:case 64:case 96:return"ARCHIVE";default:return"NA"}},elevatePPb=function(e){return PPx.Execute("%Obnq *ppb -c schtasks /run /tn "+e+"%:*wait 1000,2"),""},getFcPath=function(){var t=PPx.Extract("%*getcust(S_ppm#user:fo_fcdir)\\fastcopy.exe");return e.FileExists(t)&&t},p={parentDetails:function(e,t){return{send:{dir:e,dirtype:_getAttribute(PPx.DirectoryType)},dest:{dir:t,dirtype:_getAttribute(Number(pairsExtract("DirectoryType")[1]))}}},cmdParameters:function(e,t,r){var n="-same:"+r+" "+PPx.Extract("%*getcust(S_ppm#user:fo_options)"),i="NA"!==e.dirtype;return i?(t&&(n="-start -min "+n),{destPath:e.dir,opts:n,compcmd:"",ok:i}):isEmptyStr(e.dir)?{destPath:"%*getcust(S_ppm#user:work)%\\",opts:n,compcmd:' -compcmd *ppc -pane:~ "%%hd0" -k *jumppath -entry:"%%R"',ok:i}:void 0},switchMethod:function(e,t,r,n){return void 0===n&&(n=!1),0!==e&&(/LISTFILE|SPECIAL/.test(t.dirtype+r.dirtype)||n&&t.dir.slice(0,1).toUpperCase()!==r.dir.slice(0,1).toUpperCase())&&(e=0),e},ppcfile:function(e,t){var r=isEmptyStr(t.compcmd)?t.opts:""+t.opts+t.compcmd;return u.execute("C","*ppcfile "+e+","+t.destPath+",%("+r+"%)"),t.ok},expandFiles:function(e){u.execute("C",'*unpack "'+e+'"')},updatePairWindow:function(){return PPx.Execute('*ifmatch C*,%~n%:%K~"@^F5"')},symlinkCmdline:function(t,r){void 0===r&&(r=[]);var n=u.extract("C","%%#;FDCSN")[1].split(";"),i=u.extract("C","%%#;FCN")[1].replace(/ /g,"_").split(";");e.FolderExists(t)||u.execute("C","*makedir "+t);for(var a,c,o,p=0;p<i.length;p++){var s=[n[p],i[p]];a=s[0],c=s[1],o=":DIR"===PPx.GetFileInformation(a)?"/D ":"",r.push('"'+o+t+"\\"+c+" "+a+'"')}return r},symlink:function(e,t){var r=isEmptyStr(t)?"%Obdq ":elevatePPb(t);u.execute("C","%("+r+"FOR %%i IN ("+e.join(",")+') DO mklink %%~i>nul%&%K~"@^F5"%)')},fastCopy:function(e,t,r){var n=getFcPath();if(n){var i=t?undefined:"/no_exec",a=PPx.Extract('%*name(DCU,"%*temp()%\\fastcopy.log")'),p=PPx.EntryMarkCount,s=["%*getcust(S_ppm#user:fo_fcoptions)",i,"/cmd="+r,'/filelog="'+a+'"',u.extract("C","%%#FDC")[1],'/to="'+e+'%%\\"'].join(" ");PPx.Execute("*maxlength 10000%:*pptray -c %%Oq "+n+" "+s+"%%&*script "+o+'\\resultFastcopy.js,"'+a+'",'+p)}else u.echo(c.couldNotGetFc)}},validArgs=function(){for(var e=[],t=PPx.Arguments;!t.atEnd();t.moveNext())e.push(t.value);return e},safeArgs=function(){for(var e=[],t=validArgs(),r=0,n=arguments.length;r<n;r++)e.push(_valueConverter(r<0||arguments.length<=r?undefined:arguments[r],t[r]));return e},_valueConverter=function(e,t){if(null==t||""===t)return null!=e?e:undefined;switch(typeof e){case"number":var r=Number(t);return isNaN(r)?e:r;case"boolean":return"false"!==t&&"0"!==t&&null!=t;default:return t}},s=n[a],main=function(){var e,t,r=safeArgs(0,!1,0,""),n=r[0],i=r[1],a=r[2],c=r[3],o=1===n||3===n,d=p.parentDetails(u.extract("C","%%1")[1],u.extract("C","%%2")[1]),f=d.send,l=d.dest,x=(e="ppcfile",1===(t=p.switchMethod(n,f,l))&&i?e="fastcopy":t>1&&(e="symlink"),e),m=procSameName(a);if("ARCHIVE"!==l.dirtype)if("NA"===l.dirtype&&isEmptyStr(l.dir)&&(l.dir="%*getcust(S_ppm#user:work)%\\",o=!1),"ARCHIVE"===f.dirtype){if("symlink"===x)return void PPx.linemessage('!"'+s.abort);if("LISTFILE"===l.dirtype||"ARCHIVE"===l.dirtype)return void PPx.linemessage('!"'+s.notSupported(l.dirtype));o||(l.dir=inputPath(s.fileExpand,l.dir),"[error]"===l.dir&&PPx.Quit(1)),p.expandFiles(l.dir)}else if("symlink"===x){o||(l.dir=inputPath(s.createLink,l.dir),"[error]"===l.dir&&PPx.Quit(1));var P=p.symlinkCmdline(l.dir);p.symlink(P,c)}else if("fastcopy"===x)p.fastCopy(l.dir,o,m.fc);else{var y=p.cmdParameters(l,o,m.ppc);if(!y)return void PPx.linemessage('!"'+s.abort);p.ppcfile("copy",y)}else PPx.linemessage('!"'+s.notSupported(l.dirtype))},procSameName=function(e){return withinRange(e,2)||(e=0),{0:{ppc:"3",fc:"noexist_only"},1:{ppc:"0",fc:"update"},2:{ppc:"2",fc:"force_copy"}}[e]},inputPath=function(e,t){var r="{'text':'"+t+"','title':'"+e+"','mode':'e','select':'a','k':'*completelist -set -history:p'}";return PPx.Extract('%*script("%sgu\'ppmlib\'\\input.js","'+r+'")')};main();
